<?
require 'common.php';
$data1=["-101.00426995385;25.435219523077","-101.00206021538;25.434618630769","-101.00105853846;25.434342184615","-101.00041330769;25.434170769231","-100.99929209231;25.433865861538","-100.99914909231;25.433829107692","-100.99839806154;25.433636169231","-100.99782792308;25.433489661538","-100.99731476923;25.4333444","-100.99729023077;25.433337461538","-100.99643289231;25.433035953846","-100.99610944615;25.432909830769","-100.99608101538;25.432898815385","-100.99585464615;25.432811107692","-100.99526956923;25.432584476923","-100.99491895385;25.432448646154","-100.9942748;25.432199107692","-100.99375689231;25.431998476923","-100.99237318462;25.431484830769","-100.99126843077;25.431050692308","-100.99055941538;25.430779138462","-100.98970269231;25.430450984615","-100.98935964615;25.430317723077","-100.9891022;25.430221046154","-100.98850463077;25.429982446154","-100.98816290769;25.429850215385","-100.98712338462;25.429441969231","-100.98609112308;25.429045507692","-100.98533013846;25.428765461538","-100.98504101538;25.428659061538","-100.9847234;25.428532646154","-100.984583;25.428479861538","-100.98418070769;25.428329784615","-100.98385949231;25.428201830769","-100.98360503077;25.428108338462","-100.98329495385;25.427999261538","-100.98328221538;25.427995323077","-100.98330136923;25.427717507692","-100.98330215385;25.427706","-100.98331836923;25.426992092308","-100.98332084615;25.426882430769",
"-100.98361653846;25.425887369231","-100.98371733846;25.425555107692","-100.98376695385;25.425391507692","-100.98380287692;25.425273076923","-100.98385575385;25.425176523077","-100.98303681538;25.425312876923","-100.98265169231;25.425372246154","-100.98214290769;25.425436123077","-100.98163466154;25.425435876923","-100.98113435385;25.425442630769","-100.98075946154;25.425468969231",
"-100.98006410769;25.425534661538","-100.97884018462;25.425707938462","-100.97846758462;25.425760723077","-100.97832921538;25.425780169231","-100.97728249231;25.425927153846","-100.97611924615;25.426095446154","-100.97495976923;25.426258076923","-100.97467006154;25.426305061538","-100.97382596923;25.426427138462","-100.97263089231;25.4266","-100.97168621538;25.426736630769","-100.97145523077;25.426776123077",
"-100.97022412308;25.4269866","-100.96401009231;25.427732507692","-100.96367909231;25.427773953846","-100.96282383077;25.427896476923","-100.96099663077;25.428144692308","-100.96038593846;25.428230753846","-100.95857050769;25.428480815385","-100.95776586154;25.428591615385","-100.95760087692;25.428603738462","-100.95743776923;25.428615707692","-100.95612127692;25.428790153846","-100.95577616923;25.428860676923",
"-100.95493584615;25.428966969231","-100.95415443077;25.429083923077","-100.95371198462;25.429152553846","-100.95333655385;25.429201538462","-100.95309498462;25.429237369231","-100.95281836923;25.429276738462","-100.95268709231;25.429295430769","-100.95209363077;25.429366507692","-100.95175601538;25.429428753846",
"-100.94848598462;25.429879846154",
"-100.94819786154;25.430247153846","-100.94720393846;25.430369923077","-100.94688616923;25.430411107692","-100.94603630769;25.430529276923","-100.94577806154;25.430565415385","-100.94497103077;25.430676138462","-100.94435966154;25.430764723077","-100.94387318462;25.430827492308","-100.94373081538;25.430845553846","-100.94319864615;25.4309238","-100.94251667692;25.431015184615","-100.94214009231;25.431073384615","-100.94170541538;25.431135861538","-100.94128415385;25.4311964","-100.94060216923;25.431287784615","-100.93939390769;25.431454061538","-100.9389596;25.431513830769","-100.93792724615;25.431662907692","-100.93781170769;25.431678369231","-100.93682723077;25.431813246154","-100.93611198462;25.431910276923","-100.93576752308;25.431957338462","-100.9354536;25.432004723077","-100.93510752308;25.432052276923","-100.93452592308;25.432132215385","-100.93416901538;25.432181276923","-100.93385172308;25.432224876923","-100.93356592308;25.432264153846","-100.93352763077;25.432269415385","-100.93333953846;25.432293953846","-100.9331682;25.432323323077","-100.93295164615;25.432347538462","-100.93206009231;25.432464","-100.93116595385;25.432593876923","-100.9307488;25.432654476923","-100.93012903077;25.432752184615","-100.92895555385;25.432937184615","-100.92881349231;25.432960830769","-100.92858878462;25.4329978","-100.92776236923;25.433133784615","-100.92724329231;25.433214307692","-100.92673649231;25.433292938462","-100.9257106;25.433452092308","-100.92544098462;25.433495230769","-100.92468469231;25.4336112","-100.92365881538;25.433770369231","-100.92263292308;25.433929538462","-100.92114164615;25.434197","-100.92090803077;25.434236307692","-100.91989067692;25.434402446154","-100.91899296923;25.434542815385","-100.91756289231;25.434786923077","-100.91684830769;25.434910584615","-100.91647572308;25.434977523077","-100.91594770769;25.435067876923","-100.91477895385;25.435271984615","-100.91361021538;25.435476092308","-100.91241573846;25.435690876923","-100.91150890769;25.435843030769","-100.91060427692;25.435993661538","-100.91049896923;25.436010707692","-100.91019578462;25.436060138462","-100.90936292308;25.436199307692","-100.90925506154;25.436217369231","-100.90886944615;25.436281184615","-100.90881576923;25.436290261538"
];

foreach($data1 as $linea){
	$tmp=explode(';',$linea);
	$ruta[]=['lat'=>floatval($tmp[1]),'lng'=>floatval($tmp[0])];
}

$gpss=[];
/*
foreach($m->nlared->gpss->find([
	'imei'=>['$regex'=>'Lobus'],
	'datetime'=>['$gte'=> date('Y-m-d H:i',strtotime('-1 minutes'))]
	]) as $doc){
	$doc['id']=(string)$doc['_id'];
	$gpss2[$doc['imei']]=$doc;
	$gpss[]=[
		'id'=>$doc['id'],
		'lat'=>$doc['lat'],
		'lng'=>$doc['lng'],
		'descripcion'=>$doc['descripcion'],
		'imei'=>$doc['imei'],
	];
}*/
?>
<link rel="apple-touch-icon" href="/lobus1.jpg">
<link rel="apple-touch-startup-image" href="/lobus1.png">
<meta name="apple-mobile-web-app-title" content="Lobus Tracker">
<meta name="apple-mobile-web-app-capable" content="yes">

<div class="container bg-white" style="height:100%">
<h1><img src="lobus1.jpg" style="height:70px"><strong>Lobus Tracker</strong>
<div class="button op-darkCobalt fg-white"><span class="mif-location"></span></div></h1>
<hr>
<div class="grid" style="height:72%;">
	<div class="row padding5" style="height:100%;">
		<div id="map_canvas" style="height:100%" class="cell colspan2">map div</div>
	</div>
	<div class="row cells2">
		<div class="cell"><strong>Buzon de sugerencias</strong><br>
			<div class="input-control text">
    <input type="text" placeholder="Teclea tu comentario aqui..">
			<div class="button op-darkCobalt fg-white"><span class="mif-mail"></span></div>
</div>


			</div>
		<div class="cell align-right align-v-bottom"><strong>Desarrollado por:<span data-role="hint"
    data-hint-background="bg-green"
    data-hint-color="fg-white"
    data-hint-mode="2"
    data-hint-position="top"
    data-hint="Desarrolado por|JEFR quique@nlared.com<br>"
><img src="logo.png"></div></strong></div>
	</div>
</div>
</div><?
/*
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/es_LA/sdk.js#xfbml=1&version=v2.10&appId=443897932329541";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
		<div class="cell">
			<div class="fb-page" data-href="https://www.facebook.com/lobustracker" data-tabs="timeline" data-small-header="true" data-adapt-container-width="true" data-hide-cover="false" data-show-facepile="true"><blockquote cite="https://www.facebook.com/lobustracker" class="fb-xfbml-parse-ignore"><a href="https://www.facebook.com/lobustracker">Lobus Tracker</a></blockquote></div>
		</div>
*/
require 'paradas.php';
echo $javas;
?>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3sfg2N8eL19eAee8ncbfcxj1zfv0Mb5w&v=3.exp&sensor=false"></script>
<script>
function CoordMapType(tileSize) {
	this.tileSize = tileSize;
}
var rutas;
var map;
var myLatlng = new  google.maps.LatLng(25.43328030,-100.96047970);
var lineSymbol = { path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW };
var geocercas;
var gpss;
var markers=[];
var paradas=[];
function initialize() {
	rutas=<?=json_encode($rutas)?>
	
	var mapOptions = {
		zoom: 13,
		center: myLatlng,
		mapTypeId: google.maps.MapTypeId.TERRAIN
	};
    map = new google.maps.Map(document.getElementById('map_canvas'),mapOptions);
  
 

	gpss = <?=json_encode ($paradas)?>;
  	var infowindow = new google.maps.InfoWindow();
    
    for (i = 0; i < gpss.length; i++) {  
      var marker = new google.maps.Marker({
        position: new google.maps.LatLng(gpss[i]['lat'], gpss[i]['lng']),
        map: map,
        icon:"lobus3mini.png",
        optimized: false,
      });
      
      marker.id=i;
      
      google.maps.event.addListener(marker, 'click', (function(marker, i) {
        return function() {
          infowindow.setContent(gpss[i]['parada']);
          infowindow.open(map, marker);
        }
      })(marker, i));
      	//infowindow.open(map, marker);
      	paradas.push(marker);
    }
    
    var line = new google.maps.Polyline({
		path:<?=json_encode($ruta)?>,
	strokeColor: '<?=($gpss2[$imei]['color']!=''? $gpss2[$imei]['color']:'#000000')?>',
		geodesic: false,
		imei:'<?=$imei?>',
		strokeColor: '#FF0000',
      strokeOpacity: 0.50,
   	icons: [{
			  icon: lineSymbol,
			  offset: '100%',
			  repeat: '150px'
		}],
		map: map
	});
    
    $('#map_canvas').position({at:"center center"});
    
}



initialize();

	function recargar(){
        var encontrado;
        var nuevo;
        $.ajax({
		  url: "whereare.php",
		  cache: false,
		  success: function(data){
			for (var o = 0; o < data.length; o++) {
		  		nuevo=1;
		  		for (var i = 0; i < markers.length; i++) {
		  			if (markers[i].id == data[o].id){
		  				nuevo=0;
		  			}
		  		}
		  		if (nuevo==1){
		  			var marker = new google.maps.Marker({
						position: new google.maps.LatLng(data[o]['lat'], data[o]['lng']),
						map: map,
						 icon:"lobus2mini.png"
					});
					marker.id=data[o]['id'];
					google.maps.event.addListener(marker, 'click', (function(marker, i) {
					return function() {
						infowindow.setContent(data[o]['imei']);
						infowindow.open(map, marker);
					}
					})(marker, i));
			      	//infowindow.open(map, marker);
			      	markers.push(marker);
			      	console.log('agregando');
		  		}
			}
		  	for (var i = 0; i < markers.length; i++) {
		    	encontrado=0;
		    	for (var o = 0; o < data.length; o++) {
		    		nuevo=1;
			        if (markers[i].id == data[o].id) {
			        	encontrado=1;
			    		markers[i].setVisible(true);
		            	var lat = markers[i].getPosition().lat();
						var lng = markers[i].getPosition().lng();
		            	if(lat!=data[o].lat || lng!=data[o].lng){
		                	markers[i].setPosition( new google.maps.LatLng(data[o].lat ,data[o].lng ));
		            	}
		                //break;
		            }
		  		}
		        if(encontrado==0){
		        	markers[i].setMap(null);
		        	markers.splice(i, 1);
		        	console.log('eliminando');
		        }
		    }
		  }
		});
    }
    //set an interval
    recargar();
    setInterval(recargar, 5000);
</script>